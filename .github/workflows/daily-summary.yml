name: Daily Commit Summary (No Dependencies)

on:
  schedule:
    # 每天早上9点运行（UTC时间1点，对应北京时间9点）
    - cron: '0 1 * * *'
  # 允许手动触发
  workflow_dispatch:

jobs:
  generate-summary:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取完整的git历史
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install tsx
      run: npm install -g tsx
      
    - name: Download and run summary script
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL || 'https://api.openai.com' }}
        LARK_WEBHOOK_URL: ${{ secrets.LARK_WEBHOOK_URL }}
        REPO: ${{ github.repository }}
        MODEL_NAME: ${{ secrets.MODEL_NAME || 'gpt-4.1-mini' }}
        PER_BRANCH_LIMIT: ${{ secrets.PER_BRANCH_LIMIT || '200' }}
        DIFF_CHUNK_MAX_CHARS: ${{ secrets.DIFF_CHUNK_MAX_CHARS || '80000' }}
        TZ: ${{ secrets.TZ || 'Asia/Shanghai' }}
        DAYS_BACK: ${{ secrets.DAYS_BACK || '1' }}
        USE_COMMIT_INFO_ONLY: ${{ secrets.USE_COMMIT_INFO_ONLY || 'true' }}
      run: |
        # 下载脚本
        curl -s -o daily-summary.ts https://raw.githubusercontent.com/robertsong2000/daily-commit-summarizer/main/scripts/daily-summary.ts
        
        # 运行脚本
        npx tsx daily-summary.ts
        
        # 清理（可选）
        rm daily-summary.ts