name: Daily Commit Summary

on:
  schedule:
    # 每天早上9点运行（UTC时间1点，对应北京时间9点）
    - cron: '0 1 * * *'
  # 允许手动触发
  workflow_dispatch:

jobs:
  generate-summary:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取完整的git历史
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Generate daily summary
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL || 'https://api.openai.com' }}
        LARK_WEBHOOK_URL: ${{ secrets.LARK_WEBHOOK_URL }}
        REPO: ${{ github.repository }}
        MODEL_NAME: ${{ secrets.MODEL_NAME || 'gpt-4.1-mini' }}
        PER_BRANCH_LIMIT: ${{ secrets.PER_BRANCH_LIMIT || '200' }}
        DIFF_CHUNK_MAX_CHARS: ${{ secrets.DIFF_CHUNK_MAX_CHARS || '80000' }}
        TZ: ${{ secrets.TZ || 'Asia/Shanghai' }}
        DAYS_BACK: ${{ secrets.DAYS_BACK || '1' }}
        # 设置使用提交信息模式（可选）
        USE_COMMIT_INFO_ONLY: ${{ secrets.USE_COMMIT_INFO_ONLY || 'true' }}
      run: |
        npx tsx scripts/daily-summary.ts
        
    - name: Upload summary as artifact (optional)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: daily-summary-${{ github.run_number }}
        path: summary-*.md
        retention-days: 7